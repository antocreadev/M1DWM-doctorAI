name: Full Stack CI/CD

on:
  push:
    branches: [ main, master, dev, development, tests-ci-frontend]
  pull_request:
    branches: [ main, master ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install backend dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run backend tests
      run: |
        python -m pytest test_app.py -v
  
  frontend-validation:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Install dependencies
        run: npm ci || npm install --force
      
      - name: Lint check (optional)
        run: npm run lint || echo "Linting issues found but continuing"
      
      - name: Verify frontend project structure
        run: |
          echo "ğŸ“‚ Validating Next.js project structure..."
          
          # Fichiers racine essentiels
          echo "ğŸ” Checking root files..."
          [ -f "package.json" ] && echo "âœ… package.json exists" || { echo "âŒ package.json missing"; exit 1; }
          
          # Structure app (App Router)
          echo "ğŸ” Checking app directory structure..."
          [ -d "app" ] && echo "âœ… app directory exists" || { echo "âŒ app directory missing"; exit 1; }
          [ -f "app/layout.tsx" ] && echo "âœ… app/layout.tsx exists" || { echo "âŒ app/layout.tsx missing"; exit 1; }
          
          # Pages d'authentification
          echo "ğŸ” Checking auth pages..."
          [ -d "app/auth" ] && echo "âœ… auth directory exists" || { echo "âŒ auth directory missing"; exit 1; }
          [ -f "app/auth/login/page.tsx" ] && echo "âœ… login page exists" || { echo "âŒ login page missing"; exit 1; }
          [ -f "app/auth/register/page.tsx" ] && echo "âœ… register page exists" || { echo "âŒ register page missing"; exit 1; }
          
          echo "âœ… Frontend structure validation completed successfully!"
  
  project-summary:
    needs: [backend-tests, frontend-validation]
    runs-on: ubuntu-latest
    
    steps:
      - name: Summarize results
        run: |
          echo "ğŸ‰ CI/CD Pipeline Successful! ğŸ‰"
          echo ""
          echo "âœ… Backend tests passed successfully"
          echo "âœ… Frontend structure validated successfully"
          echo ""
          echo "Project is ready for deployment!"